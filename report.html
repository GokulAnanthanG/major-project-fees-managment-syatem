<!-- MAJOR PROJECT FESS MANAGEMENT SYSTEM -->
<!-- TEAM -->
<!--
    ****************
    G.GOKUL ANANTHAN
    N.PREM
    N.SATHISH KUMAR
    S.SUDHAKAR
    ****************
UNDER THE GUIDANCE OF
^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
MR.Ashok Lingam Sir & MR.Karuppasamy sir
^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
-->
<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <!--font awesome cdn-->
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css"
      integrity="sha512-Fo3rlrZj/k7ujTnHg4CGR2D7kSs0v4LLanw2qksYuRlEzO+tcaEPQogQ0KaoGN26/zrn20ImR1DfuLWnOo7aBA=="
      crossorigin="anonymous"
      referrerpolicy="no-referrer"
    />
   
    <!--chart-->
    <script
      src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.7.1/chart.min.js"
      integrity="sha512-QSkVNOCYLtj73J4hbmVoOV6KVZuMluZlioC+trLpewV8qMjsWqlIQvkn1KGX2StWvPMdWGBqim1xlC8krl1EKQ=="
      crossorigin="anonymous"
      referrerpolicy="no-referrer"
    ></script>
    <!--bootsrap-->
    <!-- CSS only -->
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0-beta3/dist/css/bootstrap.min.css"
      rel="stylesheet"
      integrity="sha384-eOJMYsd53ii+scO/bJGFsiCZc+5NDVN2yr8+0RDqr0Ql0h+rP48ckxlpbzKgwra6"
      crossorigin="anonymous"
    />
      <!--alert library-->
  <script src="https://unpkg.com/sweetalert/dist/sweetalert.min.js"></script>
 <!--css-->
 <link rel="stylesheet" href="./assets/css/report.css" />
 <link
   rel="shortcut icon"
   href="assets/images/favicon.ico"
   type="image/x-icon"
 />
    <title>SSB FESS MANAGEMENT SYSTEM | ADMIN Generate Report</title>
    
  </head>
  <body> 
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/2.2.4/jquery.min.js"></script>
    <script src="https://cdn.rawgit.com/rainabba/jquery-table2excel/1.1.0/dist/jquery.table2excel.min.js"></script>
    <link href="https://stackpath.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css" rel="stylesheet"
    integrity="sha384-wvfXpqpZZVQGK6TAh5PVlGOfQNHSoD2xbE+QkPxCAFlNEevoEH3Sl0sibVcOQVnN" crossorigin="anonymous">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js" integrity="sha512-GsLlZN/3F2ErC5ifS5QtgpiJtWd43JWSuIgh7mbzZ8zBps+dvLusV+eNQATqgA/HdeKFVgA5v3S/cIrLF7QnIg==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <!-- The sidebar -->
    <div class="sidebar">
        <div class="logo">
            <center>
              <img class="img-responsive" src="./assets/images/logo.png" alt="" />
              <p>SSB</p>
            </center>
          </div>
          <p class="menu-text">Menu</p>
        
        <a  href="dashboard.html">
            <i class="fa fa-home"></i>&nbsp;&nbsp;&nbsp;&nbsp;<span>Home</span>
          </a>
          <a  href="addPayment.html" title="add fees payments">
            <i class="fa fa-add"></i>&nbsp;&nbsp;&nbsp;&nbsp;<span>Fees</span>
          </a>
          <a href="recent.html" title="recent payments">
            <i class="fa fa-history"></i>&nbsp;&nbsp;&nbsp;&nbsp;<span
              >Recent</span
            >
          </a>
          <a href="search.html" title="search individual report">
            <i class="fa fa-search"></i>&nbsp;&nbsp;&nbsp;&nbsp;<span
              >Search</span
            >
          </a>
          <a class="active" href="report.html" title="view payment report and generate report for department">
            <i class="fa fa-clipboard-list"></i>&nbsp;&nbsp;&nbsp;&nbsp;<span
              >Report</span
            >
          </a>
        </a>
        <a href="staff.html" title="add staff & view,edit,delete ">
          <i class="fa fa-user-circle"></i>&nbsp;&nbsp;&nbsp;&nbsp;<span
            >Staff</span
          >
        </a>
          <a href="student.html" title="add student & view,edit,delete ">
            <i class="fa fa-user"></i>&nbsp;&nbsp;&nbsp;&nbsp;<span
              >Student</span
            >
          </a>
          <a href="setting.html" title="add sem fees for department , skill fees and rest pass">
            <i class="fa fa-gear"></i>&nbsp;&nbsp;&nbsp;&nbsp;<span>Settings</span>
          </a>
          <a href="#">
            <i class="fa-solid fa-right-from-bracket" title="logout"></i>&nbsp;&nbsp;&nbsp;&nbsp;<span>Logout</span>
          </a>
    </div>

    <!-- Page content -->
    <div class="content">
        <div class="row  top">
            <div class="col-lg-6">  <h3 class="title"><i class="fa fa-clipboard-list"></i>   Report</h3></div>
            <div class="col-lg-6 pt-4">  
                
            </div>
            <!--row-->
        </div>
<br>
      <div class="container">
        <!-- #form-->
         <input type="number" name="batch" id="batch"><input type="number" name="sem" id="sem">    <select name="department" id="department">
            <option value="">--</option>
            <option value="BCA">BCA</option>
            <option value="B.Com">B.Com</option>
            <option value="BBA">BBA</option>
            <option value="Bsc(IT)">Bsc(IT)</option>
            <option value="Bsc(Maths)">Bsc(Maths)</option>
            <option value="BA(English)">BA(English)</option>
            <option value="M.Com">M.Com</option>
        </select> <button title="search" class="search" type="button"><i class="fa fa-search" ></i></button>
      
        <div class="form">
            <button class="button1"   title="generate report as excel sheet"><i class="fa fa-file-excel"></i> </button>
            <button class="button2" id="btn2" title="filter unpayed"><i class="fa fa-filter"></i>  </button>
           <span id="status1"></span>
          <span id="status2"></span>
          <span id="status3"></span>
          <span id="status4"></span>
          <span id="status5"></span>

            <center><i class="spinner-border"></i></center>
            <table id="report-table" class="table table">
<thead class="thead-dark">
    <tr>
        <th>Name</td><th>Registration No</th><th>Department</th><th>College Fees Have To Pay</th><th>College Fees Payed</th>
<th>Skill Fees Have To Pay</th><th>Skill Fees Payed</th><th>Bus or Van Fees Have To Pay</th> <th>Bus or Van Fees Payed</th>
<th>Other Fees Have To Pay</th> <th>Other Fees Payed</th>
 <th>Fine</th>
</tr>
</thead>
<tbody>
   
</tbody>
            </table>
    </div>    
    </div>
      <!-- #end form -->
<hr>
<!--footer-->
<p align="center" class="m-1">
    &copy; Sri Sankara Bhagavthi Arts & Science College. All Rights
    Reserved
  </p>
<!--footer-->
                <!--container-->
      </div>
    <!--end content-->
</div>

<script>
    $(document).ready(function () {
        try{
    $("#batch").val(JSON.parse(localStorage.getItem("FMSbATcHSeM")).batch);
    $("#sem").val(JSON.parse(localStorage.getItem("FMSbATcHSeM")).sem)
   }
   catch(err){
    swal("please set the batch & sem", " ", "warning");
   }
        $(".button1").click(()=>{
            $("#report-table").table2excel({
            filename: `${$("#batch").val()}${$("#department").val()}sem${$("#sem").val()}report.xls`
        });

        })

$(".search").click(()=>{
    //functions
    if($("#batch").val()!=""&&$("#department").val()!=""&&$("#sem").val()!=""){
       

/* function to get batch fees */
function getBatchFees( ){
  let status=false;
  let FetchedData;
$.ajax({
  async:false,
  method:"post",
  url:"./php/getBatchFeesForbatchAndDep.php",
  data:{department:$("#department").val(),batch:$("#batch").val()},
  success:(data)=>{
    if(data!=0||data!=000){
      FetchedData= data;
    status=true;
    }
    else
    status=false;
  },
  error:(err)=>{
 status=false;
 console.log(err);
  }
})
if(status==true){
  return  Promise.resolve(FetchedData);
}
else
return Promise.reject("something went wrong")
}
/*end  function to get batch fees */

/* function to get skill fees */
function getSkillFees( ){
  let status=false;
  let FetchedData;
$.ajax({
  async:false,
  method:"post",
  url:"./php/getSkillToAddStudent.php",
  data: {batch:$("#batch").val()},
  success:(data)=>{
    if(data!=0||data!=000){
      FetchedData= data;
    status=true;
    }
    else{
      status=false;
    }
  },
  error:(err)=>{
 status=false;
 console.log(err);

  }
})
if(status==true){
  return  Promise.resolve(FetchedData);
}
else
return Promise.reject("something went wrong")
}
/*end  function to get skill fees */

/*function to filter the skill fees*/

function filterSkillFees(skillFeesDetail,studentInSkill){
try{
  if(skillFetchStaus){
    let index;skillFeesDetail.find((e,i)=>{
    if(e.value==studentInSkill){
     index=i;
    }
  })
  var skillFees=skillFeesDetail[index+1].value;
     }
     $("#status5").html("");
}
catch(err){
$("#status5").html("failed to get the skill");
$("#status5").css("color","orange");
}
  return skillFees;
  }
/*end function to filter the skill fees*/


/*function to getStudentOverAllFinePayed*/
function getStudentOverAllFinePayed(rollNo){
  let finePayed=0;
  $.ajax({
  async:false,
  method:"post",
  url:"./php/getOverAllFeesRecordsForIndivdualStudent.php",
  data: {batch:$("#batch").val(),rollNo :rollNo},
  success:(data)=>{
   if(data!=0||data!=000){
var fetchedData=JSON.parse(data);
fetchedData.forEach(e => {
    finePayed+=Number(e.fine);
});//foreach
   }//if
  }
  ,error:(err=>{ console.log(err);
})
})//
return finePayed;
}
/*end function to getStudentOverAllFinePayed*/


/* function to fetch department students */
        function getDepartmentStudents( ){
   let status=false;
  let FetchedData;
$.ajax({
  async:false,
  method:"post",
  url: "./php/getStudentDepartmentWise.php",
        data:{batch:$("#batch").val(),department:$("#department").val()},
  success:(data)=>{
    if(data!=0||data!=000){
      FetchedData= data;
    status=true;
    }
    else{
      status=false;
    }
  },
  error:(err)=>{
 status=false;
 console.log(err);

  }
})
if(status==true){
  return  Promise.resolve(FetchedData);
}
else
return Promise.reject("something went wrong")
}
/*end function to fetch department students */

/* function to get the student payment history */

function getStudentPaymentHistory(rollNo){
   let status=false;
  let FetchedData;
$.ajax({
  async:false,
  method:"post",
  url:"./php/getFeesRecordsForIndivdualStudent.php",
  data: {batch:$("#batch").val(),sem:$("#sem").val(),rollNo :rollNo},
  success:(data)=>{
      FetchedData= data;
    status=true;
  },
  error:(err)=>{
 status=false;
 console.log(err);
  }
})
if(status==true){
  return  Promise.resolve(FetchedData);
}
else
return Promise.reject("something went wrong")
}

/* end function to get the student payment history */



/* payment history calculation */

function paymentHistoryCalc(history,semFees,studentDetail,finePayed,skillFees,otherFees){
 var obj;
let semFeesPayed=0,skillFeesPayed=0,vanOrBusFeesPayed=0,otherFeesPayed=0;
let semFeesStatus=false,skillFeesstatus=false,otherFeesStatus=false,vanOrBusFeesStatus=false,fineStatus=false;
  if(history!=0){
    history.forEach(e => {
semFeesPayed+=Number(e.collegeFees);
skillFeesPayed+=Number(e.skillFees);
vanOrBusFeesPayed+=Number(e.busOrVanFees);
otherFeesPayed+=Number(otherFeesPayed);
  });//for each
/* status check */
if(semFees==semFeesPayed){
  semFeesStatus=true;
}
else{
  semFeesStatus=false;
}
if(skillFees==skillFeesPayed){
  skillFeesstatus=true;
}
else{
  skillFeesstatus=false;
}
if(otherFees==otherFeesPayed){
  otherFeesStatus=true;
}
else{
  otherFeesStatus=false;
}
if(studentDetail.vanOrBusFees==vanOrBusFeesPayed){
  vanOrBusFeesStatus=true;
}
else{
  vanOrBusFeesStatus=false;
}
if(studentDetail.fine==finePayed){
  fineStatus=true;
}
else{
  fineStatus=false;
}

/*end status check */

  obj={
    name:studentDetail.name,
    regNo:studentDetail.regNo,
    department:studentDetail.department,
    semFees:semFees,
    semFeesPayed:semFeesPayed,
    semFeesHaveToPay:semFees-semFeesPayed,
    skillFees:skillFees,
    skillFeesPayed:skillFeesPayed,
    skillFeesHaveToPay:skillFees-skillFeesPayed,
    vanOrBusFees:studentDetail.vanOrBusFees,
    vanOrBusFeesPayed:vanOrBusFeesPayed,
    vanOrBusFeesHaveToPay:studentDetail.vanOrBusFees-vanOrBusFeesPayed,
    otherFees:otherFees,
    otherFeesPayed:otherFeesPayed,
    otherFeesHaveToPay:otherFees-otherFeesPayed,
    fine:studentDetail.fine-finePayed,
    semFeesStatus:semFeesStatus,
    skillFeesstatus:skillFeesstatus,
    otherFeesStatus:otherFeesStatus,
    vanOrBusFeesStatus:vanOrBusFeesStatus,
    fineStatus:fineStatus,
  }
  }//if
  else if(history==0){
obj={
  name:studentDetail.name,
    regNo:studentDetail.regNo,
    department:studentDetail.department,
    semFees:semFees,
    semFeesPayed:semFeesPayed,
    semFeesHaveToPay:semFees-semFeesPayed,
    skillFees:skillFees,
    skillFeesPayed:skillFeesPayed,
    skillFeesHaveToPay:skillFees-skillFeesPayed,
    vanOrBusFees:studentDetail.vanOrBusFees,
    vanOrBusFeesPayed:vanOrBusFeesPayed,
    vanOrBusFeesHaveToPay:studentDetail.vanOrBusFees-vanOrBusFeesPayed,
    otherFees:otherFees,
    otherFeesPayed:otherFeesPayed,
    otherFeesHaveToPay:otherFees-otherFeesPayed,
    fine:studentDetail.fine-finePayed,
    semFeesStatus:semFeesStatus,
    skillFeesstatus:skillFeesstatus,
    otherFeesStatus:otherFeesStatus,
    vanOrBusFeesStatus:vanOrBusFeesStatus,
    fineStatus:fineStatus,
}
  }
return Promise.resolve(obj);
}

/*end paument history calculation */
/* start function process */
var skillFetchStaus=false;
async function process(){

//pro getting batch
try{
  var batchfees=await getBatchFees();
batchfees=JSON.parse(batchfees);
var $semFees=batchfees.semFees;
var $otherFees=0;
 if($("#sem").val()==1){
 $otherFees=batchfees.otherFeesForSem1
}
else if($("#sem").val()==2){
  $otherFees=batchfees.otherFeesForSem2
}
else if($("#sem").val()==3){
  $otherFees=batchfees.otherFeesForSem3
}
else if($("#sem").val()==4){
  $otherFees=batchfees.otherFeesForSem4
}
else if($("#sem").val()==5){
  $otherFees=batchfees.otherFeesForSem5;
}
else if($("#sem").val()==6){
  $otherFees=batchfees.otherFeesForSem6
  $("#status1").html(" ")
}
 
 }
catch(err){
  $("#status1").html("failed to get batch fees")
  $("#status1").css("color","orange");
}
//end pro getting batch

//pro getting skill fees
try{
  var skillFees=await getSkillFees();
skillFees=JSON.parse(skillFees);
  skillFetchStaus=true;
  $("#status2").html(" ")
 }
catch{
  skillFetchStaus=false;
  $("#status2").css("color","orange")
  $("#status2").html("failed to get skill")
}
//end pro getting skill fees


//pro getting department students

try{
var students=await getDepartmentStudents();
 students=JSON.parse(students);
 $("#status3").html(" ");
 }
catch(err){
  $("#status3").css("color","orange")
  $("#status3").html("failed to get department students check the datas are added or not");
}
//end pro getting department students
 
var studentPaymentTable=[];

/*---calc---*/
$("#report-table tbody").empty();
students.forEach(async student => {
var _$skillFees=filterSkillFees(skillFees,student.skill);
var _$overallFinePayed=getStudentOverAllFinePayed(student.rollNo);
var _$semFees=$semFees;
var _$otherFees=$otherFees;
try{
  var payment=await getStudentPaymentHistory(student.rollNo);
  payment=JSON.parse(payment);
  var calcedData= await paymentHistoryCalc(payment,_$semFees,student,_$overallFinePayed,_$skillFees,_$otherFees);
  $("#report-table tbody").append(`
  <tr>
        <td>${calcedData.name}</td>
        <td>${calcedData.regNo}</td>
        <td>${calcedData.department}</td>  
        <td>${calcedData.semFeesHaveToPay}</td>
        <td>${calcedData.semFeesPayed}</td>
        <td>${calcedData.skillFeesHaveToPay}</td>
        <td>${calcedData.skillFeesPayed}</td>
        <td>${calcedData.vanOrBusFeesHaveToPay}</td>
        <td>${calcedData.vanOrBusFeesPayed}</td>
        <td>${calcedData.otherFeesHaveToPay}</td>
        <td>${calcedData.otherFeesPayed}</td>
        <td>${calcedData.fine}</td>
         </tr>
  `)
  studentPaymentTable.push(calcedData);
  $("#status4").html(" "); 
}
catch(err){
  console.log(err);
 $("#status4").html("failed to get payment history");
 $("#status4").css("color","orange");
}

});//foreach
/*---end calc---*/


}
process();
/* end function process */


    }
    else
    swal("please enter the batch ,sem,and departmnet", " ", "warning");
})//search
    

    });
</script>
 
</body>
  
 </html>
